<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <!-- ëª¨ë°”ì¼ ì„¸ë¡œ ëª¨ë“œ ìµœì í™” ë° íŠ•ê¹€ ë°©ì§€ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- ëª¨ë°”ì¼ ì•± ì„¤ì¹˜ìš© ì•„ì´ì½˜ ë° ì„¤ì • (app_icon.png í•„ìš”) -->
    <link rel="icon" type="image/png" href="app_icon.png">
    <link rel="apple-touch-icon" href="app_icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    
    <title>ê·¸ë¦¼ ê·¸ë¦¬ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            background-color: #f8fafc;
            overflow: hidden; /* ìŠ¤í¬ë¡¤ ë°©ì§€ */
            font-family: 'Arial', 'Apple SD Gothic Neo', sans-serif;
        }
        
        #home-screen {
            background-color: #ffffff; /* ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê¹”ë”í•œ í°ìƒ‰ ë°°ê²½ */
            background-image: url('family_photo.png');
            background-size: cover;
            background-position: center top;
            background-repeat: no-repeat;
        }
        
        #home-overlay {
            background: rgba(255, 255, 255, 0.1); 
        }

        /* ì „ì²´ ì„¸ë¡œí˜• ë ˆì´ì•„ì›ƒ êµ¬ì„± */
        #main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh; /* iOS Safari í•˜ë‹¨ë°” ëŒ€ì‘ */
            width: 100vw;
            position: relative;
            background-color: #f1f5f9;
        }
        
        /* íˆ´ ë²„íŠ¼ ë””ìì¸ */
        .tool-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 3px solid #f1f5f9;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            flex-shrink: 0;
            position: relative;
            background-color: white;
            scroll-snap-align: center;
        }
        .tool-btn:active { transform: scale(0.9); }
        .tool-btn.active {
            transform: scale(1.15);
            border-color: #3b82f6;
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.4);
            z-index: 10;
        }

        /* ì–‡ì€ ê°€ë¡œí˜• êµµê¸° ì¡°ì ˆ ìŠ¬ë¼ì´ë” */
        .thickness-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 8px;
            outline: none;
        }
        .thickness-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            background: #3b82f6;
            border: 3px solid white;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .thickness-slider::-webkit-slider-thumb:active {
            transform: scale(1.2);
        }

        /* ì¹´í…Œê³ ë¦¬ íƒ­ ë””ìì¸ */
        .category-tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-weight: 800;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #94a3b8;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            background-color: #f8fafc;
            border: 1px solid transparent;
            border-bottom: none;
            white-space: nowrap;
        }
        .category-tab.active {
            background: white;
            color: #3b82f6;
            border-color: #e2e8f0;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° ë° ìŠ¤ì™€ì´í”„ ë¶€ë“œëŸ½ê²Œ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { 
            -ms-overflow-style: none; 
            scrollbar-width: none; 
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .icon-btn {
            transition: transform 0.1s;
        }
        .icon-btn:active {
            transform: scale(0.85);
        }
        
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }

        /* ì§‘ì¤‘ ëª¨ë“œ ì• ë‹ˆë©”ì´ì…˜ ì²˜ë¦¬ */
        #footer {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body>

    <!-- í™ˆ í™”ë©´ -->
    <div id="home-screen" class="fixed inset-0 z-[100] flex items-end lg:items-center justify-center px-4 pt-6 pb-[calc(env(safe-area-inset-bottom)+24px)]">
        <div id="home-overlay" class="absolute inset-0"></div>

        <div class="relative z-10 flex flex-col items-center justify-center p-6 sm:p-8 bg-white/90 backdrop-blur-xl border border-white/60 shadow-2xl rounded-[2.5rem] w-[92%] max-w-sm text-center overflow-auto max-h-[72dvh] lg:max-h-none lg:overflow-visible transform transition-all">

            <div class="inline-block px-4 py-1.5 bg-blue-100 text-blue-600 rounded-full text-xs sm:text-sm font-extrabold mb-4 shadow-sm border border-blue-200">
                ì‚¬ë‘í•˜ëŠ” ì•„ë“¤ ì´ì¤€ì´ë¥¼ ìœ„í•œ
            </div>

            <h1 class="text-4xl font-black text-slate-800 mb-6 flex items-center justify-center gap-2 whitespace-nowrap">
                ê·¸ë¦¼ ê·¸ë¦¬ê¸° <span class="animate-bounce drop-shadow-md">ğŸ¨</span>
            </h1>

            <!-- ê°€ì¡± ì •ë³´ ë°•ìŠ¤ (ì•„ë¹  -> ì•„ë“¤ -> ì—„ë§ˆ ìˆœì„œ) -->
            <div class="w-full bg-slate-50/80 rounded-2xl p-4 mb-8 border border-slate-200/60 shadow-inner">
                <p class="text-sm text-slate-700 font-extrabold mb-3 flex items-center justify-center gap-1">
                    <span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦</span> ì‚¬ë‘í•˜ëŠ” ìš°ë¦¬ê°€ì¡± <span>â¤ï¸</span>
                </p>
                <div class="flex justify-center gap-2 text-xs font-bold text-slate-600 whitespace-nowrap">
                    <span class="bg-white px-2 py-1.5 rounded-lg border border-slate-200 shadow-sm"><span class="text-blue-600">ì •ê²½ë¬¸</span> ì•„ë¹ </span>
                    <span class="bg-white px-2 py-1.5 rounded-lg border border-slate-200 shadow-sm"><span class="text-green-600">ì •ì´ì¤€</span> ì•„ë“¤</span>
                    <span class="bg-white px-2 py-1.5 rounded-lg border border-slate-200 shadow-sm"><span class="text-pink-600">ì´ë¥œì˜</span> ì—„ë§ˆ</span>
                </div>
            </div>

            <button onclick="startGame()" class="w-full bg-gradient-to-r from-pink-500 to-rose-500 hover:from-pink-600 hover:to-rose-600 text-white text-2xl font-bold py-4 rounded-2xl shadow-lg shadow-pink-500/30 transition-transform active:scale-95 flex justify-center items-center gap-2">
                <span>ë†€ì´ ì‹œì‘!</span> <span class="text-3xl">ğŸš€</span>
            </button>
        </div>
    </div>

    <!-- ì„¤ì • ëª¨ë‹¬ ì°½ -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-[200] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-[32px] w-[90%] max-w-sm shadow-2xl transform transition-all">
            <h2 class="text-3xl font-bold text-slate-800 mb-6 text-center">âš™ï¸ ì„¤ì •</h2>
            
            <div class="flex items-center justify-between bg-slate-50 p-4 rounded-2xl mb-6">
                <div>
                    <p class="text-lg font-bold text-slate-700">ì§‘ì¤‘ ëª¨ë“œ (í•˜ë‹¨ ë©”ë‰´ ìˆ¨ê¸°ê¸°)</p>
                    <p class="text-xs text-slate-500 mt-1">ê·¸ë¦¼ì„ ê·¸ë¦´ ë•Œ í•˜ë‹¨ ë©”ë‰´ê°€ ìŠ¤ë¥´ë¥µ ìˆ¨ì–´ ë„í™”ì§€ê°€ ë„“ì–´ì§‘ë‹ˆë‹¤.</p>
                </div>
                <div class="relative inline-block w-14 align-middle select-none transition duration-200 ease-in shrink-0">
                    <input type="checkbox" name="toggle" id="focus-toggle" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer z-10 transition-all duration-300" onclick="toggleFocusMode()" checked/>
                    <label for="focus-toggle" class="toggle-label block overflow-hidden h-7 rounded-full bg-blue-500 cursor-pointer transition-colors duration-300"></label>
                </div>
            </div>

            <button onclick="closeSettings()" class="w-full bg-blue-500 text-white font-bold text-xl py-4 rounded-2xl active:scale-95 transition-transform shadow-lg">
                í™•ì¸
            </button>
        </div>
    </div>

    <!-- ê²Œì„ í™”ë©´ (ì„¸ë¡œí˜• ì™„ë²½ ìµœì í™”) -->
    <div id="main-container" class="hidden">
        
        <!-- 1. ìƒë‹¨ ë©”ë‰´ë°” (ê·¸ë¦¼ ê·¸ë¦´ ë•Œ ì•ˆ ìˆ¨ê²¨ì§) -->
        <div id="header" class="flex items-center justify-between px-4 py-3 bg-white shadow-sm z-30 shrink-0">
            <!-- ì¢Œì¸¡ íƒ€ì´í‹€ -->
            <h1 class="text-base sm:text-lg font-black text-slate-800 tracking-tight whitespace-nowrap">
                ì •ì´ì¤€ì„ ìœ„í•œ ê·¸ë¦¼ê·¸ë¦¬ê¸°
            </h1>
            
            <!-- ìš°ì¸¡ ë²„íŠ¼ë“¤ (ë’¤ë¡œê°€ê¸°, ìº¡ì²˜, ì„¤ì •, í™ˆ) -->
            <div class="flex gap-2">
                <button onclick="undo()" class="icon-btn bg-yellow-100 text-yellow-600 font-bold w-9 h-9 sm:w-10 sm:h-10 rounded-full text-sm sm:text-base shadow-sm border border-yellow-200 flex justify-center items-center">â†©ï¸</button>
                <button onclick="saveDrawing()" class="icon-btn bg-blue-100 text-blue-600 font-bold w-9 h-9 sm:w-10 sm:h-10 rounded-full text-sm sm:text-base shadow-sm border border-blue-200 flex justify-center items-center">ğŸ“¸</button>
                <button onclick="openSettings()" class="icon-btn bg-gray-100 text-gray-600 font-bold w-9 h-9 sm:w-10 sm:h-10 rounded-full text-sm sm:text-base shadow-sm border border-gray-200 flex justify-center items-center">âš™ï¸</button>
                <button onclick="goHome()" class="icon-btn bg-pink-100 text-pink-600 font-bold w-9 h-9 sm:w-10 sm:h-10 rounded-full text-sm sm:text-base shadow-sm border border-pink-200 flex justify-center items-center">ğŸ </button>
            </div>
            
            <!-- ì¹­ì°¬ íŒì—… -->
            <div id="success-badge" class="absolute left-1/2 -translate-x-1/2 top-14 hidden praise-toast bg-yellow-400 text-white px-6 py-2 rounded-full font-bold text-lg shadow-xl border-2 border-white z-50 whitespace-nowrap">
                <span id="praise-text">ìµœê³ ì˜ˆìš”!</span> ğŸŒŸ
            </div>
        </div>

        <!-- 2. 1ë‹¨ ê°€ë¡œ ìŠ¤í¬ë¡¤ ì»¬ëŸ¬ íŒ”ë ˆíŠ¸ & ë‘ê»˜ ì¡°ì ˆê¸° (ê·¸ë¦¼ ê·¸ë¦´ ë•Œ ì•ˆ ìˆ¨ê²¨ì§) -->
        <div id="palette-section" class="bg-white shadow-sm z-20 shrink-0 border-b border-slate-200 pb-3 pt-2">
            <!-- 1ë‹¨ ê°€ë¡œ ìŠ¤í¬ë¡¤ ì»¬ëŸ¬ ê·¸ë¦¬ë“œ -->
            <div id="tools-area" class="flex flex-row gap-3 px-4 pb-3 overflow-x-auto no-scrollbar snap-x touch-pan-x items-center">
                <!-- JSì—ì„œ ë™ì  ìƒì„±ë¨ -->
            </div>
            
            <!-- íœ ë‘ê»˜ ì¡°ì ˆ -->
            <div class="px-6 flex items-center gap-4 w-full max-w-md mx-auto">
                <span class="text-[10px] font-bold text-slate-400 whitespace-nowrap">ì–‡ê²Œ</span>
                <input type="range" id="thicknessSlider" class="thickness-slider flex-1" min="2" max="35" value="10">
                <span class="text-[10px] font-bold text-slate-400 whitespace-nowrap">êµµê²Œ</span>
            </div>
        </div>

        <!-- 3. ê·¸ë¦¼ ê·¸ë¦¬ê¸° êµ¬ì—­ (Flex-1ë¡œ ë‚¨ëŠ” ê³µê°„ ëª¨ë‘ ì°¨ì§€í•˜ì—¬ ê°€ì¥ ë„“ìŒ) -->
        <div id="canvas-area" class="flex-1 relative p-3 sm:p-4 flex justify-center items-center overflow-hidden z-10 w-full">
            <div id="canvas-wrapper" class="relative bg-white rounded-3xl shadow-md w-full h-full overflow-hidden border-4 border-white">
                <canvas id="bgCanvas" class="absolute inset-0 touch-none"></canvas>
                <canvas id="drawingCanvas" class="absolute inset-0 touch-none"></canvas>
            </div>
        </div>

        <!-- 4. í•˜ë‹¨ ì¹´í…Œê³ ë¦¬ íƒ­ & ì•„ì´ì½˜ ë¦¬ìŠ¤íŠ¸ (ê·¸ë¦¼ ê·¸ë¦´ ë•Œ ìˆ¨ê²¨ì§) -->
        <div id="footer" class="bg-white z-20 shrink-0 shadow-[0_-4px_15px_rgba(0,0,0,0.03)] pt-1">
            <!-- í•˜ìœ„ ì•„ì´ì½˜ ë¦¬ìŠ¤íŠ¸ (ììœ ê·¸ë¦¬ê¸°ì¼ ë•ŒëŠ” ìˆ¨ê¹€) -->
            <div id="item-list-container" class="transition-all duration-300 overflow-hidden">
                <div id="item-list" class="flex overflow-x-auto no-scrollbar gap-4 px-4 py-3 items-center min-h-[90px] bg-slate-50 snap-x">
                    <!-- JSì—ì„œ ë™ì  ìƒì„±ë¨ -->
                </div>
            </div>
            
            <!-- ë©”ì¸ ì¹´í…Œê³ ë¦¬ íƒ­ (ììœ ê·¸ë¦¬ê¸°ë¥¼ ê°€ì¥ ì²« íƒ­ìœ¼ë¡œ ë°°ì¹˜) -->
            <div class="flex px-2 pt-0 gap-1 overflow-x-auto no-scrollbar bg-slate-100/50">
                <div id="tab-free" onclick="setCategory('free')" class="category-tab active">âœ¨ ììœ ê·¸ë¦¬ê¸°</div>
                <div id="tab-basic" onclick="setCategory('basic')" class="category-tab">ë„í˜•</div>
                <div id="tab-fruit" onclick="setCategory('fruit')" class="category-tab">ê³¼ì¼</div>
                <div id="tab-heavy" onclick="setCategory('heavy')" class="category-tab">ì¤‘ì¥ë¹„ ğŸš§</div>
            </div>
        </div>
        
    </div>

    <script>
        const homeScreen = document.getElementById('home-screen');
        const mainContainer = document.getElementById('main-container');
        const drawingCanvas = document.getElementById('drawingCanvas');
        const bgCanvas = document.getElementById('bgCanvas');
        const drawCtx = drawingCanvas.getContext('2d');
        const bgCtx = bgCanvas.getContext('2d');
        const paletteTools = document.getElementById('tools-area');
        const itemList = document.getElementById('item-list');
        const itemListContainer = document.getElementById('item-list-container');
        const successBadge = document.getElementById('success-badge');
        const praiseText = document.getElementById('praise-text');
        const thicknessSlider = document.getElementById('thicknessSlider');
        const header = document.getElementById('header');
        const paletteSection = document.getElementById('palette-section');
        const footer = document.getElementById('footer');

        let isDrawing = false;
        let currentStageIndex = 0;
        let currentCategory = 'free'; // ê¸°ë³¸ê°’ ììœ ê·¸ë¦¬ê¸°ë¡œ ì‹œì‘
        let selectedColor = '#000000'; // ê¸°ë³¸ ê²€ì •ìƒ‰
        let isEraser = false;
        let isCompleted = false;
        let currentStroke = [];
        let totalStrokeCount = 0;
        let strokeWidth = 10; 

        let undoHistory = [];
        let isFocusModeEnabled = true;
        let focusTimeout = null;
        let eraserLongPressTimer;


        // ====== ë„ì•ˆ(ë°°ê²½ ê°€ì´ë“œ) ìŠ¤íƒ€ì¼ ê³ ì • ======
        // ìš”ì²­ì‚¬í•­: ì ì„  ê°„ê²© 5px / ì„  êµµê¸° 2px / ì„  ìƒ‰ìƒ #9ca3af(ë‘ë²ˆì§¸ ì˜…ì€ íšŒìƒ‰) ê³ ì •
        const GUIDE_COLOR = "#9ca3af";
        const GUIDE_LINE_PX = 2;
        const GUIDE_DASH_PX = 5;
        const GUIDE_DOTTED = true; // 'í† ë“œ(ë„íŠ¸)=ì ì„ ' ê³ ì • ì ìš©

        // âœ… DPR(ë ˆí‹°ë‚˜) ê°’ì€ resizeCanvas()ì—ì„œ ê°±ì‹ ë©ë‹ˆë‹¤.
        let DEVICE_DPR = 1;

        function applyGuideStyle(ctx, scale) {
            ctx.strokeStyle = GUIDE_COLOR;
            ctx.lineCap = "round";
            ctx.lineJoin = "round";

            // âœ… í™”ë©´(CSS) ê¸°ì¤€ 2px/5pxë¡œ ë³´ì´ë„ë¡ (ìŠ¤ì¼€ì¼ + DPR ëª¨ë‘ ì—­ë³´ì •)
            const denom = Math.max(0.0001, scale * DEVICE_DPR);
            ctx.lineWidth = GUIDE_LINE_PX / denom;
            ctx.setLineDash(GUIDE_DOTTED ? [GUIDE_DASH_PX / denom, GUIDE_DASH_PX / denom] : []);
        }

        // ì•„ì´ë“¤ì´ ì¢‹ì•„í•˜ëŠ” ë‹¤ì–‘í•œ 25ê°€ì§€ ì»¬ëŸ¬ ë°°ì¹˜
        const colors = [
            '#FF0000', '#FF4500', '#FF8C00', '#FFD700', '#FFFF00', // ë¹¨ê°•~ë…¸ë‘ê³„ì—´
            '#ADFF2F', '#32CD32', '#228B22', '#008000', // ì´ˆë¡ê³„ì—´
            '#00FFFF', '#00CED1', '#87CEFA', '#1E90FF', '#0000FF', '#00008B', // íŒŒë‘/ì²­ë¡ê³„ì—´
            '#8A2BE2', '#9370DB', '#FF69B4', '#FFB6C1', // ë³´ë¼/í•‘í¬ê³„ì—´
            '#8B4513', '#D2691E', '#F5DEB3', // ê°ˆìƒ‰/ì‚´êµ¬ìƒ‰ê³„ì—´
            '#000000', '#64748b', '#cbd5e1'  // ë¬´ì±„ìƒ‰ê³„ì—´
        ];

        const praises = ["ìš°ì™€! ì •ë§ ì˜ ê·¸ë ¸ì–´ìš”!", "ìš°ë¦¬ ì´ì¤€ì´ ìµœê³ ! ë©‹ì ¸ìš”!", "ë°˜ì§ë°˜ì§ ë¹›ë‚˜ëŠ” ê·¸ë¦¼!", "ì–´ì©œ ì´ë ‡ê²Œ ì˜í• ê¹Œ?", "ê¼¬ë§ˆ í™”ê°€ë‹˜ ê°™ì•„ìš”!", "ì •ë§ ì˜ˆìœ ìƒ‰ê¹”ì´ë„¤ìš”!", "ê·¸ë¦¼ ê·¸ë¦¬ê¸°ê°€ ì¦ê±°ì›Œìš”!", "ëŒ€ë‹¨í•œ ì§‘ì¤‘ë ¥!", "ì„ ì´ ì‚´ì•„ìˆë„¤ìš”!", "ê¼¬ë§ˆ ì˜ˆìˆ ê°€ë‹˜, ìµœê³ !"];

        const drawWheel = (ctx, x, y, r) => {
            ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.stroke();
            ctx.beginPath(); ctx.arc(x, y, r / 3, 0, Math.PI * 2); ctx.stroke();
        };


        // ====== SVG ìŠ¤íƒ€ì¼ ë„ì•ˆì„ Canvasì— ê·¸ë¦¬ê¸° ìœ„í•œ í—¬í¼ ======
        const strokePath = (ctx, d) => ctx.stroke(new Path2D(d));
        const strokeLine = (ctx, x1, y1, x2, y2) => { ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke(); };
        const strokeCircle = (ctx, cx, cy, r) => { ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.stroke(); };
        const strokeEllipse = (ctx, cx, cy, rx, ry, rotDeg = 0) => {
            ctx.beginPath();
            ctx.ellipse(cx, cy, rx, ry, rotDeg * Math.PI / 180, 0, Math.PI * 2);
            ctx.stroke();
        };
        const strokeRect = (ctx, x, y, w, h, r = 0) => {
            if (r && ctx.roundRect) {
                ctx.beginPath();
                ctx.roundRect(x, y, w, h, r);
                ctx.stroke();
                return;
            }
            ctx.strokeRect(x, y, w, h);
        };

        // ====== ìš”ì²­í•˜ì‹  SVG ì½”ë“œ ê¸°ë°˜ ë„ì•ˆ(ì§€ê²Œì°¨/ë¤í”„íŠ¸ëŸ­/í¬ë ˆì¸) ======
        // viewBox: 0 0 600 400 ê¸°ì¤€ ì¢Œí‘œ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const drawForkliftSVG = (ctx) => {
            // ì°¨ì²´
            strokePath(ctx, "M 60,320 H 380 V 220 H 280 V 180 H 100 V 250 H 60 Z");
            // ìºë¹ˆ í”„ë ˆì„
            strokePath(ctx, "M 100,180 L 120,60 H 260 L 280,180");
            strokeLine(ctx, 125, 75, 255, 75);
            // ì˜ì ë° í•¸ë“¤
            strokePath(ctx, "M 130,180 V 130 H 160 V 160 H 190 V 180");
            strokeLine(ctx, 260, 180, 230, 130);
            strokeEllipse(ctx, 230, 130, 20, 6, -20);
            // ë§ˆìŠ¤íŠ¸ ë° í¬í¬
            strokeRect(ctx, 380, 40, 30, 300);
            strokePath(ctx, "M 410,240 H 435 V 320 H 560 V 340 H 410 Z");
            // ë°”í€´
            strokeCircle(ctx, 140, 320, 45);
            strokeCircle(ctx, 140, 320, 15);
            strokeCircle(ctx, 300, 320, 45);
            strokeCircle(ctx, 300, 320, 15);
        };

        const drawDumpTruckSVG = (ctx) => {
            // ìš´ì „ì„
            strokePath(ctx, "M 60,320 V 180 H 180 L 220,320 Z");
            strokeRect(ctx, 85, 195, 45, 45, 3);
            strokeRect(ctx, 145, 195, 35, 45, 3);
            // ì ì¬í•¨ & ëŠ‘ì¬
            strokePath(ctx, "M 220,320 V 160 H 540 V 320 Z");
            strokeLine(ctx, 285, 160, 285, 320);
            strokeLine(ctx, 350, 160, 350, 320);
            strokeLine(ctx, 415, 160, 415, 320);
            strokeLine(ctx, 480, 160, 480, 320);
            // í™ë”ë¯¸
            strokePath(ctx, "M 250,160 Q 320,60 400,160 Q 450,80 520,160");
            // ë°”í€´
            strokeCircle(ctx, 120, 320, 45);
            strokeCircle(ctx, 360, 320, 45);
            strokeCircle(ctx, 480, 320, 45);
        };

        const drawCraneSVG = (ctx) => {
            strokePath(ctx, "M 40,360 L 560,360");
            strokePath(ctx, "M 100,360 L 240,360 L 240,340 L 190,340 L 190,320 L 150,320 L 150,340 L 100,340 Z");
            strokeRect(ctx, 150, 100, 40, 220);
            strokePath(ctx, "M 150,100 L 190,140 M 190,100 L 150,140 M 150,140 L 190,180 M 190,140 L 150,180 M 150,180 L 190,220 M 190,180 L 150,220 M 150,220 L 190,260 M 190,220 L 150,260 M 150,260 L 190,300 M 190,260 L 150,300 M 150,300 L 190,320 M 190,300 L 150,320");
            strokePath(ctx, "M 190,120 L 240,120 L 250,160 L 190,160 Z");
            strokePath(ctx, "M 190,130 L 235,130 L 242,160");
            strokePath(ctx, "M 150,80 L 40,80 L 40,100 L 150,100");
            strokeRect(ctx, 40, 70, 40, 40);
            strokePath(ctx, "M 190,80 L 540,80 L 540,100 L 190,100");
            strokePath(ctx, "M 190,100 L 215,80 L 240,100 L 265,80 L 290,100 L 315,80 L 340,100 L 365,80 L 390,100 L 415,80 L 440,100 L 465,80 L 490,100 L 515,80 L 540,100");
            strokePath(ctx, "M 150,80 L 170,30 L 190,80");
            strokeLine(ctx, 170, 30, 170, 80);
            strokeLine(ctx, 170, 30, 50, 80);
            strokeLine(ctx, 170, 30, 330, 80);
            strokeLine(ctx, 170, 30, 480, 80);
            strokeRect(ctx, 460, 100, 30, 10);
            strokeLine(ctx, 475, 110, 475, 250);
            strokeRect(ctx, 465, 250, 20, 20);
            strokePath(ctx, "M 475,270 C 475,290 495,290 495,275 C 495,265 485,265 485,275");
        };


        // âœ… ë ˆë¯¸ì½˜(ê°•í™” ë””ìì¸) - 600x400 ì¢Œí‘œê³„(viewBox) ê¸°ë°˜
        // ì•„ë˜ êµ¬ê°„ë§Œ ìˆ˜ì •í•˜ë©´ ë ˆë¯¸ì½˜ ëª¨ì–‘ì„ ì‰½ê²Œ ë°”ê¿€ ìˆ˜ ìˆì–´ìš”.
        const drawMixerTruckSVG = (ctx) => {
            // 1) ì§€ë©´(ë°”ë‹¥ì„ )
            strokePath(ctx, "M 20 360 L 580 360");

            // 2) ìš´ì „ì„(ìº¡) ì™¸ê³½
            strokePath(ctx, "M 60 310 V 210 Q 60 190 80 190 H 180 Q 200 190 200 210 V 310 H 60 Z");
            // 3) ì°½ë¬¸(2ê°œ)
            strokeRect(ctx, 80, 205, 50, 50, 6);
            strokeRect(ctx, 140, 205, 50, 50, 6);

            // 4) ë¯¹ì„œ ë“œëŸ¼(ëª¸í†µ)
            strokePath(ctx, "M 210,250 L 250,110 C 270,70 320,60 380,60 L 500,120 L 530,220 L 500,300 L 210,300 Z");
            // 5) ë“œëŸ¼ íšŒì „ ë‚˜ì„ (ë””í…Œì¼)
            strokePath(ctx, "M 320,65 Q 260,180 230,295");
            strokePath(ctx, "M 410,85 Q 350,200 320,300");
            strokePath(ctx, "M 490,125 Q 430,240 400,300");

            // 6) í›„ë©´ ê¹”ë•Œê¸°/ë°°ì¶œêµ¬
            strokePath(ctx, "M 530,160 L 570,140 L 570,220 L 530,200");
            strokePath(ctx, "M 540,250 L 580,270 L 560,300 L 530,280");

            // 7) ë°”í€´(3ê°œ)
            strokeCircle(ctx, 130, 320, 40); strokeCircle(ctx, 130, 320, 15);
            strokeCircle(ctx, 360, 320, 40); strokeCircle(ctx, 360, 320, 15);
            strokeCircle(ctx, 460, 320, 40); strokeCircle(ctx, 460, 320, 15);
        };



        // âœ… ë¡¤ëŸ¬ì°¨(ê°•í™” ë””ìì¸) - 600x400 ì¢Œí‘œê³„(viewBox) ê¸°ë°˜
        const drawRoadRollerSVG = (ctx) => {
            strokePath(ctx, "M 20 360 L 580 360");

            strokePath(ctx, "M 50,280 V 180 H 120 V 160 H 280 V 280 H 50 Z");
            strokeRect(ctx, 150, 180, 100, 30, 6);
            strokeLine(ctx, 160, 180, 160, 210);
            strokeLine(ctx, 180, 180, 180, 210);

            strokePath(ctx, "M 180,160 V 90 H 280 V 160");
            strokeRect(ctx, 200, 100, 65, 45, 6);

            strokeRect(ctx, 280, 220, 30, 50, 5);
            strokeCircle(ctx, 295, 245, 5);

            strokePath(ctx, "M 310,250 L 410,250 L 410,290 L 310,290 Z");

            strokeCircle(ctx, 420, 255, 105);
            strokeCircle(ctx, 420, 255, 30);
            strokePath(ctx, "M 315,255 A 105,105 0 0,1 525,255");

            strokeCircle(ctx, 150, 285, 75);
            strokeCircle(ctx, 150, 285, 25);
        };


        const heavyDrawings = {
            dumpTruck: (ctx) => { drawDumpTruckSVG(ctx); },
            mixerTruck: (ctx) => { drawMixerTruckSVG(ctx); },
            crane: (ctx) => { drawCraneSVG(ctx); },
            forklift: (ctx) => { drawForkliftSVG(ctx); },
            roadRoller: (ctx) => { drawRoadRollerSVG(ctx); },
            excavatorBody: (ctx) => {
                ctx.beginPath(); ctx.roundRect(-80, 25, 70, 20, 10); ctx.stroke();
                drawWheel(ctx, -65, 35, 6); drawWheel(ctx, -45, 35, 6); drawWheel(ctx, -25, 35, 6);
                ctx.beginPath(); ctx.moveTo(-70, 25); ctx.lineTo(-70, -25); ctx.lineTo(-40, -25); ctx.lineTo(-40, -5); ctx.lineTo(-20, -5); ctx.lineTo(-20, 25); ctx.closePath(); ctx.stroke();
                ctx.strokeRect(-65, -20, 20, 20); ctx.beginPath(); ctx.moveTo(-40, 5); ctx.lineTo(10, -70); ctx.lineTo(25, -60); ctx.lineTo(-20, 15); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(15, -65); ctx.lineTo(70, -5); ctx.lineTo(60, 5); ctx.lineTo(5, -55); ctx.stroke();
            },
            excavatorBucket: (ctx) => {
                ctx.save(); ctx.translate(-5, 0); 
                heavyDrawings.excavatorBody(ctx);
                ctx.beginPath(); ctx.moveTo(70, -5); ctx.quadraticCurveTo(115, 10, 100, 55); ctx.lineTo(50, 25); ctx.closePath(); ctx.stroke();
                [[100,55,108,70,92,51],[88,48,96,63,80,42],[75,38,83,53,67,32]].forEach(v => {
                    ctx.beginPath(); ctx.moveTo(v[0],v[1]); ctx.lineTo(v[2],v[3]); ctx.lineTo(v[4],v[5]); ctx.stroke();
                });
                ctx.restore();
            },
            excavatorDrill: (ctx) => {
                ctx.save(); ctx.translate(-5, 0); 
                heavyDrawings.excavatorBody(ctx);
                ctx.strokeRect(55, -5, 25, 45); ctx.beginPath(); ctx.moveTo(60, 40); ctx.lineTo(67, 95); ctx.lineTo(75, 40); ctx.closePath(); ctx.stroke();
                ctx.restore();
            },
            excavatorGrapple: (ctx) => {
                ctx.save(); ctx.translate(-5, 0); 
                heavyDrawings.excavatorBody(ctx);
                ctx.beginPath(); ctx.moveTo(70, -5); ctx.quadraticCurveTo(125, -15, 115, 45); ctx.lineTo(95, 25); ctx.quadraticCurveTo(90, 5, 70, 5); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(60, 5); ctx.quadraticCurveTo(35, 45, 75, 70); ctx.lineTo(85, 45); ctx.quadraticCurveTo(70, 30, 60, 5); ctx.stroke();
                ctx.restore();
            }
        };

        const fruitDrawings = {
            apple: (ctx) => {
                ctx.beginPath(); ctx.moveTo(0, -30); ctx.bezierCurveTo(-60,-40,-70,30,-40,55); ctx.bezierCurveTo(-15,70,15,70,40,55); ctx.bezierCurveTo(70,30,60,-40,0,-30); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, -30); ctx.lineTo(-5, -60); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(-5, -50); ctx.quadraticCurveTo(30, -70, 40, -40); ctx.quadraticCurveTo(15, -20, -5, -50); ctx.stroke();
            },
            strawberry: (ctx) => {
                ctx.beginPath(); ctx.moveTo(0, -30); ctx.bezierCurveTo(60,-30,60,20,15,70); ctx.quadraticCurveTo(0,80,-15,70); ctx.bezierCurveTo(-60,20,-60,-30,0,-30); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, -25); [[-25,-40],[-10,-30],[0,-50],[10,-30],[25,-40]].forEach(p => { ctx.lineTo(p[0],p[1]); ctx.lineTo(0,-25); }); ctx.stroke();
                [[-20,0],[20,0],[0,15],[-25,30],[25,30],[-10,45],[10,45],[0,60]].forEach(s => { ctx.beginPath(); ctx.ellipse(s[0],s[1],2,4,0,0,Math.PI*2); ctx.stroke(); });
            },
            watermelon: (ctx) => {
                ctx.beginPath(); ctx.moveTo(-60, 0); ctx.lineTo(60, 0); ctx.arc(0, 0, 60, 0, Math.PI); ctx.closePath(); ctx.stroke();
                ctx.beginPath(); ctx.arc(0, 0, 45, 0, Math.PI); ctx.stroke();
                [[-30,25],[0,30],[30,25],[-15,15],[15,15]].forEach(s => { ctx.beginPath(); ctx.ellipse(s[0],s[1],3,5,0,0,Math.PI*2); ctx.stroke(); });
            },
            banana: (ctx) => {
                ctx.beginPath(); ctx.moveTo(45, -35); ctx.lineTo(55, -30); ctx.bezierCurveTo(65, 25, 15, 65, -50, 20); ctx.quadraticCurveTo(-65, 5, -55, -5); ctx.bezierCurveTo(-10, 40, 35, 5, 40, -20); ctx.closePath(); ctx.stroke();
            },
            blueberry: (ctx) => {
                ctx.beginPath(); ctx.ellipse(0, 5, 55, 40, 0, 0, Math.PI * 2); ctx.stroke();
                ctx.beginPath(); ctx.ellipse(0, -28, 20, 6, 0, 0, Math.PI); ctx.stroke();
            },
            grapes: (ctx) => {
                const grapes = [[-25, -10], [0, -10], [25, -10], [-15, 15], [15, 15], [0, 40]];
                grapes.forEach(([x, y]) => { ctx.beginPath(); ctx.arc(x, y, 18, 0, Math.PI * 2); ctx.stroke(); });
                ctx.beginPath(); ctx.moveTo(0, -28); ctx.lineTo(0, -55); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, -45); ctx.quadraticCurveTo(-20, -65, -35, -45); ctx.quadraticCurveTo(-20, -30, 0, -45); ctx.stroke();
            },
            cherry: (ctx) => {
                ctx.beginPath(); ctx.arc(-22, 25, 22, 0, Math.PI * 2); ctx.stroke();
                ctx.beginPath(); ctx.arc(22, 25, 22, 0, Math.PI * 2); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(-22, 3); ctx.quadraticCurveTo(-10, -30, 0, -45); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(22, 3); ctx.quadraticCurveTo(10, -30, 0, -45); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, -45); ctx.quadraticCurveTo(30, -55, 35, -35); ctx.quadraticCurveTo(15, -25, 0, -45); ctx.stroke();
            },
            peach: (ctx) => {
                ctx.beginPath(); ctx.moveTo(0, -30); ctx.bezierCurveTo(-50, -45, -60, 15, 0, 55); ctx.bezierCurveTo(60, 15, 50, -45, 0, -30); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, -30); ctx.quadraticCurveTo(-15, 10, 0, 55); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, -30); ctx.quadraticCurveTo(25, -55, 40, -35); ctx.quadraticCurveTo(20, -15, 0, -30); ctx.stroke();
            },
            pineapple: (ctx) => {
                ctx.beginPath(); ctx.ellipse(0, 15, 35, 45, 0, 0, Math.PI * 2); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(-15, -25); ctx.lineTo(-35, -65); ctx.lineTo(-5, -30); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(-5, -30); ctx.lineTo(0, -75); ctx.lineTo(5, -30); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(5, -30); ctx.lineTo(35, -65); ctx.lineTo(15, -25); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(-20, -10); ctx.lineTo(20, 40); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(-20, 40); ctx.lineTo(20, -10); ctx.stroke();
            },
            orange: (ctx) => {
                ctx.beginPath(); ctx.ellipse(0, 5, 55, 45, 0, 0, Math.PI * 2); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, -45); ctx.lineTo(4, -42); ctx.lineTo(10, -44); ctx.lineTo(6, -38); ctx.lineTo(8, -32); ctx.lineTo(0, -35); ctx.lineTo(-8, -32); ctx.lineTo(-6, -38); ctx.lineTo(-10, -44); ctx.lineTo(-4, -42); ctx.closePath(); ctx.stroke();
                ctx.beginPath(); ctx.ellipse(0, -38, 3, 1.5, 0, 0, Math.PI * 2); ctx.stroke();
            }
        };

        // í•˜ìœ„ ë¦¬ìŠ¤íŠ¸ (ììœ  ê·¸ë¦¬ê¸°ëŠ” ì œê±°ë¨)
        const allStages = {
            free: [], 
            basic: [
                { title: "ì§ì„ ", type: "line", icon: "ğŸ“" },
                { title: "ë™ê·¸ë¼ë¯¸", type: "circle", icon: "â­•" },
                { title: "ë„¤ëª¨", type: "square", icon: "â¬›" },
                { title: "ì„¸ëª¨", type: "triangle", icon: "ğŸ”º" },
                { title: "ë³„", type: "star", icon: "â­" },
                { title: "í•˜íŠ¸", type: "heart", icon: "â¤ï¸" }
            ],
            fruit: [
                { title: "ì‚¬ê³¼", type: "custom", draw: fruitDrawings.apple, icon: "ğŸ", color: '#FF0000' },
                { title: "ë”¸ê¸°", type: "custom", draw: fruitDrawings.strawberry, icon: "ğŸ“", color: '#FF0000' },
                { title: "ìˆ˜ë°•", type: "custom", draw: fruitDrawings.watermelon, icon: "ğŸ‰", color: '#228B22' },
                { title: "ë°”ë‚˜ë‚˜", type: "custom", draw: fruitDrawings.banana, icon: "ğŸŒ", color: '#FFD700' },
                { title: "ë¸”ë£¨ë² ë¦¬", type: "custom", draw: fruitDrawings.blueberry, icon: "ğŸ«", color: '#1E90FF' },
                { title: "í¬ë„", type: "custom", draw: fruitDrawings.grapes, icon: "ğŸ‡", color: '#9370DB' },
                { title: "ì²´ë¦¬", type: "custom", draw: fruitDrawings.cherry, icon: "ğŸ’", color: '#FF0000' },
                { title: "ë³µìˆ­ì•„", type: "custom", draw: fruitDrawings.peach, icon: "ğŸ‘", color: '#FF69B4' },
                { title: "íŒŒì¸ì• í”Œ", type: "custom", draw: fruitDrawings.pineapple, icon: "ğŸ", color: '#FFD700' },
                { title: "ê·¤", type: "custom", draw: fruitDrawings.orange, icon: "ğŸŠ", color: '#FF8C00' }
            ],
            heavy: [
                { title: "ë¤í”„íŠ¸ëŸ­", type: "custom", draw: heavyDrawings.dumpTruck, icon: "ğŸš›", svg: true },
                { title: "ë ˆë¯¸ì½˜", type: "custom", draw: heavyDrawings.mixerTruck, icon: "ğŸšš", svg: true },
                { title: "í¬ë ˆì¸", type: "custom", draw: heavyDrawings.crane, icon: "ğŸ—ï¸", svg: true },
                { title: "ì§€ê²Œì°¨", type: "custom", draw: heavyDrawings.forklift, icon: "ğŸ“¦", svg: true },
                { title: "ë¡¤ëŸ¬ì°¨", type: "custom", draw: heavyDrawings.roadRoller, icon: "ğŸšœ", svg: true },
                { title: "í¬í¬ë ˆì¸", type: "custom", draw: heavyDrawings.excavatorBucket, icon: "ğŸ—ï¸" },
                { title: "ë“œë¦´ì°¨", type: "custom", draw: heavyDrawings.excavatorDrill, icon: "ğŸ”¨" },
                { title: "ì§‘ê²Œì°¨", type: "custom", draw: heavyDrawings.excavatorGrapple, icon: "ğŸ¦€" }
            ]
        };

        function triggerHaptic() {
            if (navigator.vibrate) {
                navigator.vibrate(15);
            }
        }

        function toggleFocusMode() {
            triggerHaptic();
            const checkbox = document.getElementById('focus-toggle');
            isFocusModeEnabled = checkbox.checked;
        }

        function openSettings() {
            triggerHaptic();
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettings() {
            triggerHaptic();
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function startGame() {
            triggerHaptic();
            if (window.AudioContext || window.webkitAudioContext) {
                const ac = new (window.AudioContext || window.webkitAudioContext)();
                ac.resume();
            }
            homeScreen.classList.add('hidden');
            mainContainer.classList.remove('hidden');
            mainContainer.classList.add('flex');
            
            // ì²« ì‹œì‘ ì‹œ ë”œë ˆì´ ì£¼ê³  ìº”ë²„ìŠ¤ ì‚¬ì´ì¦ˆ ê³„ì‚°
            setTimeout(() => {
                resizeCanvas();
                setCategory('free'); // ì‹œì‘ ì‹œ ììœ ê·¸ë¦¬ê¸° í™œì„±í™”
            }, 50);
        }

        function goHome() {
            triggerHaptic();
            homeScreen.classList.remove('hidden');
            mainContainer.classList.add('hidden');
            mainContainer.classList.remove('flex');
        }

        function initPalette() {
            paletteTools.innerHTML = '';
            
            // ì§€ìš°ê°œ ë„êµ¬
            const eraser = createTool('ğŸ§½', () => { 
                triggerHaptic();
                isEraser = true; 
                initPalette(); 
            });
            if (isEraser) eraser.classList.add('active');
            
            eraser.addEventListener('pointerdown', startEraserTimer);
            eraser.addEventListener('pointerup', cancelEraserTimer);
            eraser.addEventListener('pointerleave', cancelEraserTimer);
            
            paletteTools.appendChild(eraser);

            // ìƒ‰ìƒ ë°°ì¹˜
            colors.forEach(color => {
                const dot = createTool('', () => { 
                    triggerHaptic();
                    selectedColor = color; 
                    isEraser = false; 
                    initPalette(); 
                });
                dot.style.backgroundColor = color;
                if (!isEraser && selectedColor === color) dot.classList.add('active');
                paletteTools.appendChild(dot);
            });
            
            // ì „ì²´ ì§€ìš°ê¸° ë²„íŠ¼ì„ íŒ”ë ˆíŠ¸ ëª©ë¡ ë§ˆì§€ë§‰ì— ì¶”ê°€
            const clearBtn = createTool('ğŸ§¹', () => { triggerHaptic(); resetCanvas(); });
            paletteTools.appendChild(clearBtn);
        }

        function startEraserTimer(e) {
            eraserLongPressTimer = setTimeout(() => {
                triggerHaptic();
                resetCanvas();
                playWinSound();
                praiseText.innerText = "ì“±ì“±~ ëª¨ë‘ ì§€ì› ì–´ìš”!";
                successBadge.classList.remove('hidden');
                setTimeout(() => successBadge.classList.add('hidden'), 2000);
            }, 800); 
        }

        function cancelEraserTimer() {
            clearTimeout(eraserLongPressTimer);
        }

        function createTool(inner, onClick) {
            const btn = document.createElement('div');
            btn.className = 'tool-btn snap-center';
            btn.innerHTML = `<span style="font-size:1.6rem">${inner}</span>`;
            btn.onclick = onClick;
            return btn;
        }

        thicknessSlider.oninput = function() {
            strokeWidth = parseInt(this.value);
        };

        function setCategory(cat) {
            triggerHaptic();
            currentCategory = cat;
            currentStageIndex = 0; 
            
            // íƒ­ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
            document.querySelectorAll('.category-tab').forEach(t => {
                t.classList.remove('active');
            });
            document.getElementById(`tab-${cat}`).classList.add('active');
            
            // ììœ ê·¸ë¦¬ê¸° ì„ íƒ ì‹œ í•˜ìœ„ ì•„ì´ì½˜ ìˆ¨ê¹€
            if(cat === 'free') {
                itemListContainer.style.height = '0px';
                itemList.innerHTML = '';
            } else {
                itemListContainer.style.height = '100px';
                renderItems();
            }
            
            // ë ˆì´ì•„ì›ƒì´ ë³€í•œ ë’¤ì— ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ë‹¤ì‹œ ë§ì¶”ê¸° ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° í›„ ë¦¬ì‚¬ì´ì¦ˆ
            setTimeout(() => {
                resizeCanvas(false);
                // âœ… ë¦¬ì‚¬ì´ì¦ˆ ì§í›„ 1í”„ë ˆì„ ë’¤ì— ë„ì•ˆì„ ê·¸ë¦¬ë©´(íŠ¹íˆ ëª¨ë°”ì¼) ëˆ„ë½ì´ ì¤„ì–´ë“­ë‹ˆë‹¤.
                requestAnimationFrame(() => initStage());
            }, 250);
        }

        function renderItems() {
            itemList.innerHTML = '';
            allStages[currentCategory].forEach((stage, idx) => {
                const btn = document.createElement('button');
                // ì„ íƒëœ ì•„ì´í…œ ê°•ì¡° ìŠ¤íƒ€ì¼
                const isActive = currentStageIndex === idx;
                btn.className = `flex flex-col items-center min-w-[75px] transition-all snap-center ${isActive ? 'scale-110 opacity-100 drop-shadow-md' : 'scale-95 opacity-60'}`;
                
                btn.onclick = () => { 
                    triggerHaptic();
                    currentStageIndex = idx; 
                    renderItems(); // í´ë¦­ ì‹œ ë‹¤ì‹œ ë Œë”ë§í•´ì„œ ê°•ì¡° ìŠ¤íƒ€ì¼ ë³€ê²½
                    // âœ… ëª¨ë°”ì¼/íƒœë¸”ë¦¿ì—ì„œ ë ˆì´ì•„ì›ƒ ê³„ì‚°ì´ ëŠ¦ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ í•œ ë²ˆ ë” ë¦¬ì‚¬ì´ì¦ˆ í›„ ë„ì•ˆ ê°±ì‹ 
                    requestAnimationFrame(() => { resizeCanvas(false); initStage(); }); 
                };
                btn.innerHTML = `<span class="text-4xl sm:text-5xl mb-1">${stage.icon}</span><span class="text-xs sm:text-sm font-bold text-slate-700">${stage.title}</span>`;
                itemList.appendChild(btn);
            });
        }

        
        function resizeCanvas(shouldRedraw = true) {
            const area = document.getElementById('canvas-area');
            if (area.clientWidth === 0) return;

            // âœ… ìº”ë²„ìŠ¤ ì˜ì—­ íŒ¨ë”©(ê¸°ì¡´ UI ìœ ì§€)
            const paddingX = 24;
            const paddingY = 24;

            const wrapper = document.getElementById('canvas-wrapper');

            // wrapper í¬ê¸° ì§€ì •(í™”ë©´ì— ë³´ì´ëŠ” í¬ê¸°)
            const cssW = Math.max(10, area.clientWidth - paddingX);
            const cssH = Math.max(10, area.clientHeight - paddingY);
            wrapper.style.width = cssW + 'px';
            wrapper.style.height = cssH + 'px';

            // âœ… ì‹¤ì œ í™”ë©´(CSS) ê¸°ì¤€ í¬ê¸° ì¬ì¸¡ì • (ëª¨ë°”ì¼ì—ì„œ ê³„ì‚° ì˜¤ì°¨/ì§€ì—° ë°©ì§€)
            const rect = wrapper.getBoundingClientRect();
            const w = Math.max(10, rect.width);
            const h = Math.max(10, rect.height);

            // âœ… DPR(ë ˆí‹°ë‚˜) ê°±ì‹ 
            DEVICE_DPR = Math.max(1, window.devicePixelRatio || 1);

            // âœ… ìº”ë²„ìŠ¤ CSS í¬ê¸°ê¹Œì§€ ëª…ì‹œ(í„°ì¹˜ ì¢Œí‘œ/ë³´ì´ëŠ” ì˜ì—­ ë¶ˆì¼ì¹˜ ë°©ì§€)
            drawingCanvas.style.width = w + 'px';
            drawingCanvas.style.height = h + 'px';
            bgCanvas.style.width = w + 'px';
            bgCanvas.style.height = h + 'px';

            // âœ… ë¹„íŠ¸ë§µ í¬ê¸°(ë ˆí‹°ë‚˜ ì„ ëª…ë„)
            drawingCanvas.width = Math.round(w * DEVICE_DPR);
            drawingCanvas.height = Math.round(h * DEVICE_DPR);
            bgCanvas.width = Math.round(w * DEVICE_DPR);
            bgCanvas.height = Math.round(h * DEVICE_DPR);

            // âœ… ì¢Œí‘œê³„ëŠ” CSS px ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©
            drawCtx.setTransform(DEVICE_DPR, 0, 0, DEVICE_DPR, 0, 0);
            bgCtx.setTransform(DEVICE_DPR, 0, 0, DEVICE_DPR, 0, 0);

            if (shouldRedraw) initStage();
        }


        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('load', () => {
            initPalette();
        });

        function saveHistory() {
            undoHistory.push(drawCtx.getImageData(0, 0, drawingCanvas.width, drawingCanvas.height));
            if (undoHistory.length > 20) undoHistory.shift();
        }

        function undo() {
            triggerHaptic();
            if (undoHistory.length > 0) {
                const lastState = undoHistory.pop();
                drawCtx.putImageData(lastState, 0, 0);
            } else {
                drawCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            }
        }

        function resetCanvas() { 
            saveHistory(); 
            drawCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        }

        function initStage() {
            isCompleted = false; 
            totalStrokeCount = 0;
            undoHistory = []; 
            successBadge.classList.add('hidden'); 
            
            drawCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);

            // ììœ ê·¸ë¦¬ê¸° ì²˜ë¦¬
            if (currentCategory === 'free') {
                return;
            }

            let stage = allStages[currentCategory][currentStageIndex];
            if (!stage) return;

            // ê³¼ì¼ ë“±ì— í• ë‹¹ëœ ê¸°ë³¸ ìƒ‰ìƒì´ ìˆë‹¤ë©´ ìë™ ë³€ê²½
            if (stage.color) {
                selectedColor = stage.color;
                isEraser = false;
                initPalette();
            }

            drawBackgroundGuide(stage);
        }

        
        function drawBackgroundGuide(stage) {
            // âš ï¸ ìº”ë²„ìŠ¤ëŠ” DPR(ë ˆí‹°ë‚˜)ë¡œ í™•ëŒ€ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, í™”ë©´(CSS) í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•´ì•¼ í•©ë‹ˆë‹¤.
            const rect = bgCanvas.getBoundingClientRect();
            const cw = rect.width;
            const ch = rect.height;
            if (!cw || !ch) return;

            bgCtx.save();

            // âœ… SVG ì¢Œí‘œ(600x400) ê¸°ë°˜ ë„ì•ˆ: "í™”ë©´ ì•ˆì— ë¬´ì¡°ê±´ ë“¤ì–´ì˜¤ê²Œ(Fit)" ë°°ì¹˜
            if (stage.svg) {
                const padding = Math.min(32, Math.round(Math.min(cw, ch) * 0.06)); // ëª¨ë°”ì¼ ì—¬ë°±
                const availW = Math.max(10, cw - padding * 2);
                const availH = Math.max(10, ch - padding * 2);

                const scale = Math.min(availW / 600, availH / 400) * 0.98;

                const tx = (cw - 600 * scale) / 2;
                const ty = (ch - 400 * scale) / 2;

                bgCtx.translate(tx, ty);
                bgCtx.scale(scale, scale);

                applyGuideStyle(bgCtx, scale);
                stage.draw(bgCtx);

                bgCtx.restore();
                return;
            }

            // âœ… ê¸°ì¡´ ë„í˜•/ê³¼ì¼/ê¸°íƒ€ ë„ì•ˆ(ì„¼í„° ê¸°ì¤€ í™•ëŒ€)ë„ CSS í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
            const minDim = Math.min(cw, ch);
            const baseScale = minDim / 350;
            const scale = baseScale * 1.5;

            bgCtx.translate(cw / 2, ch / 2);
            bgCtx.scale(scale, scale);

            applyGuideStyle(bgCtx, scale);

            if (stage.type === "custom") {
                stage.draw(bgCtx);
            } else {
                const s = 50;
                bgCtx.beginPath();
                switch(stage.type) {
                    case "line": bgCtx.moveTo(-s*2, 0); bgCtx.lineTo(s*2, 0); break;
                    case "circle": bgCtx.arc(0, 0, s*1.5, 0, Math.PI * 2); break;
                    case "square": bgCtx.strokeRect(-s, -s, s*2, s*2); break;
                    case "triangle": bgCtx.moveTo(0, -s); bgCtx.lineTo(s, s); bgCtx.lineTo(-s, s); bgCtx.closePath(); break;
                    case "star":
                        for(let i=0;i<10;i++){
                            const r=i%2?s:s/2;
                            const a=Math.PI*2*i/10-Math.PI/2;
                            bgCtx.lineTo(r*Math.cos(a),r*Math.sin(a));
                        }
                        bgCtx.closePath();
                        break;
                    case "heart":
                        bgCtx.moveTo(0, -15);
                        bgCtx.bezierCurveTo(50, -60, 90, 10, 0, 70);
                        bgCtx.bezierCurveTo(-90, 10, -50, -60, 0, -15);
                        break;
                }
                bgCtx.stroke();
            }

            bgCtx.restore();
        }


        function getPointerPos(e) {
            const rect = drawingCanvas.getBoundingClientRect();
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }

        function handleStart(e) {
            isDrawing = true;
            try { drawingCanvas.setPointerCapture(e.pointerId); } catch(err) {}
            const pos = getPointerPos(e);
            
            saveHistory();

            // ì§‘ì¤‘ ëª¨ë“œ: í•˜ë‹¨ ë©”ë‰´ë°”ë§Œ ìŠ¤ë¥´ë¥µ ìˆ¨ê¸°ê¸° (ìƒë‹¨ ë° íŒ”ë ˆíŠ¸ëŠ” ìœ ì§€)
            if (isFocusModeEnabled) {
                clearTimeout(focusTimeout);
                footer.style.transform = 'translateY(100%)';
            }

            currentStroke = [pos];
            drawCtx.beginPath();
            drawCtx.moveTo(pos.x, pos.y);
            playSound(200, 0.1);
        }

        function handleMove(e) {
            if (!isDrawing) return;
            const pos = getPointerPos(e);
            if (isEraser) {
                drawCtx.globalCompositeOperation = 'destination-out';
                drawCtx.lineWidth = strokeWidth * 1.5;
            } else {
                drawCtx.globalCompositeOperation = 'source-over';
                drawCtx.lineWidth = strokeWidth;
                drawCtx.strokeStyle = selectedColor;
            }
            drawCtx.lineCap = "round"; drawCtx.lineJoin = "round";
            drawCtx.lineTo(pos.x, pos.y); drawCtx.stroke();
            currentStroke.push(pos);
        }

        function handleEnd(e) {
            if (!isDrawing) return;
            isDrawing = false;

            try { drawingCanvas.releasePointerCapture(e.pointerId); } catch(err) {}

            // ì§‘ì¤‘ ëª¨ë“œ: 1ì´ˆ ë’¤ì— í•˜ë‹¨ ë©”ë‰´ ë‹¤ì‹œ ë³´ì´ê¸°
            if (isFocusModeEnabled) {
                focusTimeout = setTimeout(() => {
                    footer.style.transform = 'translateY(0)';
                }, 1000);
            }

            if (currentStroke.length > 5) analyzeStroke(currentStroke);
        }

        function analyzeStroke(stroke) {
            if (isEraser || currentCategory === 'free') return; // ììœ ê·¸ë¦¬ê¸°ì—ì„œëŠ” ì¹­ì°¬ ì´í™íŠ¸ ë¬´ì‹œ
            let length = 0;
            for(let i=1; i<stroke.length; i++) length += Math.hypot(stroke[i].x - stroke[i-1].x, stroke[i].y - stroke[i-1].y);
            if (length > 40) {
                totalStrokeCount++;
                if (totalStrokeCount > 3) triggerPraise();
            }
        }

        function triggerPraise() {
            if (isCompleted) return;
            isCompleted = true;
            praiseText.innerText = praises[Math.floor(Math.random() * praises.length)];
            successBadge.classList.remove('hidden');
            playWinSound(); createCelebration(); 
            setTimeout(() => { successBadge.classList.add('hidden'); isCompleted = false; }, 4000);
        }

        function playSound(freq, duration) {
            try {
                const ac = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ac.createOscillator(); const gain = ac.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(freq, ac.currentTime);
                gain.gain.setValueAtTime(0.05, ac.currentTime); 
                gain.gain.exponentialRampToValueAtTime(0.01, ac.currentTime + duration);
                osc.connect(gain); gain.connect(ac.destination);
                osc.start(); osc.stop(ac.currentTime + duration);
            } catch(e) {}
        }

        function playWinSound() {
            playSound(523.25, 0.2); setTimeout(() => playSound(659.25, 0.2), 150); setTimeout(() => playSound(783.99, 0.4), 300);
        }

        function createCelebration() {
            triggerHaptic(); 
            const celebrationColors = ['#FF0000', '#FFD93D', '#4CAF50', '#4D96FF', '#FF69B4', '#9C27B0'];
            for (let i = 0; i < 80; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.top = '-20px';
                conf.style.backgroundColor = celebrationColors[Math.floor(Math.random() * celebrationColors.length)];
                const size = Math.random() * 12 + 10; 
                conf.style.width = size + 'px'; conf.style.height = size + 'px';
                document.body.appendChild(conf);
                conf.animate([{ transform: 'translateY(0) rotate(0deg)', opacity: 1 }, { transform: `translate(${(Math.random()-0.5)*400}px, 110vh) rotate(${Math.random()*1000}deg)`, opacity: 0 }], { duration: 1500 + Math.random() * 1000, easing: 'ease-out' }).onfinish = () => conf.remove();
            }
        }

        function saveDrawing() {
            triggerHaptic();
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = drawingCanvas.width; tempCanvas.height = drawingCanvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.fillStyle = "white"; tempCtx.fillRect(0,0,tempCanvas.width, tempCanvas.height);
            tempCtx.drawImage(bgCanvas, 0, 0); tempCtx.drawImage(drawingCanvas, 0, 0);
            const link = document.createElement('a');
            link.download = `ì´ì¤€ì´ì˜ê·¸ë¦¼_${new Date().getTime()}.png`;
            link.href = tempCanvas.toDataURL(); link.click();
            praiseText.innerText = "ì°°ì¹µ! ì‚¬ì§„ìœ¼ë¡œ ì €ì¥í–ˆì–´ìš”!";
            successBadge.classList.remove('hidden');
            setTimeout(() => successBadge.classList.add('hidden'), 2000);
        }

        // âœ… ëª¨ë°”ì¼/íƒœë¸”ë¦¿/íœ ì…ë ¥ê¹Œì§€ ì•ˆì •ì ì¸ Pointer Events ì‚¬ìš©
        drawingCanvas.style.touchAction = 'none';

        drawingCanvas.addEventListener('pointerdown', (e) => { e.preventDefault(); handleStart(e); }, { passive: false });
        drawingCanvas.addEventListener('pointermove', (e) => { e.preventDefault(); handleMove(e); }, { passive: false });
        drawingCanvas.addEventListener('pointerup', (e) => { e.preventDefault(); handleEnd(e); }, { passive: false });
        drawingCanvas.addEventListener('pointercancel', (e) => { e.preventDefault(); handleEnd(e); }, { passive: false });
        drawingCanvas.addEventListener('pointerleave', (e) => { e.preventDefault(); handleEnd(e); }, { passive: false });

    </script>
</body>
</html>